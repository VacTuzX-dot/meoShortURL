name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual trigger

jobs:
  # QA / Continuous Integration Job
  ci:
    name: QA - Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: rust-backend

      - name: Build Rust Backend
        working-directory: rust-backend
        run: cargo build --release

      - name: Setup Node for Frontend
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Frontend Dependencies
        run: npm install

      - name: Build Frontend
        run: npm run build

  # Continuous Deployment Job (Only runs if QA passes)
  deploy:
    name: Deploy to Production
    needs: ci
    runs-on: ubuntu-latest

    env:
      # ดึงค่าจาก Secrets มาพักไว้
      APP_DIR: ${{ secrets.APP_DIR }}
      SSH_HOST: ${{ secrets.HOST_IP }}
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_PORT: ${{ secrets.SSH_PORT }}
      # ค่า Config ของแอป
      BASE_URL: ${{ secrets.BASE_URL }}
      PORT: ${{ secrets.PORT }}
      DISCORD_CLIENT_ID: ${{ secrets.DISCORD_CLIENT_ID }}
      DISCORD_CLIENT_SECRET: ${{ secrets.DISCORD_CLIENT_SECRET }}
      DISCORD_REDIRECT_URI: ${{ secrets.DISCORD_REDIRECT_URI }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:cicd

      - name: Debug Tailscale (on failure)
        if: failure()
        run: |
          echo "=== tailscaled.log ==="
          sudo cat ~/tailscaled.log || true
          echo "=== tailscale status ==="
          sudo tailscale status --json || sudo tailscale status || true
          sudo tailscale version || true

      - name: Setup SSH Key
        env:
          SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          # Create .ssh directory
          mkdir -p ~/.ssh

          # Check for Secrets
          if [ -z "$SSH_KEY" ]; then
            echo "Error: SSH_PRIVATE_KEY secret is missing or empty."
            exit 1
          fi
          if [ -z "$SSH_HOST" ]; then
            echo "Error: HOST_IP secret is missing or empty. Please check GitHub Secrets."
            exit 1
          fi

          # Setup Identity File
          printf '%s\n' "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # Retry ssh-keyscan until successful (max 10 attempts)
          CLEAN_HOST=$(echo "$SSH_HOST" | xargs)
          CLEAN_PORT=$(echo "${SSH_PORT:-22}" | xargs)

          echo "Scanning host: $CLEAN_HOST on port $CLEAN_PORT"

          MAX_RETRIES=10
          RETRY_DELAY=5
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Attempt $((RETRY_COUNT + 1)) of $MAX_RETRIES..."
            if ssh-keyscan -p "$CLEAN_PORT" "$CLEAN_HOST" >> ~/.ssh/known_hosts 2>/dev/null; then
              if [ -s ~/.ssh/known_hosts ]; then
                echo "✅ Host key successfully added to known_hosts"
                break
              fi
            fi
            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "ssh-keyscan failed, retrying in ${RETRY_DELAY}s..."
              sleep $RETRY_DELAY
            fi
          done

          # Verify known_hosts has content
          if [ ! -s ~/.ssh/known_hosts ]; then
            echo "❌ Error: Failed to scan host key after $MAX_RETRIES attempts"
            exit 1
          fi

      - name: Upload project files
        run: |
          # สร้างโฟลเดอร์ปลายทาง
          ssh -p "${SSH_PORT:-22}" "$SSH_USER@$SSH_HOST" "mkdir -p '$APP_DIR'"

          # บีบอัดไฟล์และส่งข้ามไป
          tar -czf - \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='.github' \
            --exclude='*.sqlite' \
            --exclude='.env' \
            --exclude='target' \
            . | ssh -p "${SSH_PORT:-22}" "$SSH_USER@$SSH_HOST" "tar -xzf - -C '$APP_DIR'"

      - name: Deploy with Docker Compose
        run: |
          ssh -p "${SSH_PORT:-22}" "$SSH_USER@$SSH_HOST" <<EOF
            set -e
            cd "$APP_DIR"
            
            # 1. สร้างไฟล์ .env บน Server
            echo "BASE_URL=${BASE_URL}" > .env
            echo "PORT=${PORT}" >> .env
            echo "DISCORD_CLIENT_ID=${DISCORD_CLIENT_ID}" >> .env
            echo "DISCORD_CLIENT_SECRET=${DISCORD_CLIENT_SECRET}" >> .env
            echo "DISCORD_REDIRECT_URI=${DISCORD_REDIRECT_URI}" >> .env
            
            # 2. สั่ง Build และ Run (port 3006)
            docker compose up -d --build --remove-orphans
            
            # 3. ลบ Image "Dangling" (ที่ไม่ถูกใช้โดย Container ใดๆ ทั้ง run/stop)
            docker image prune -f
          EOF
