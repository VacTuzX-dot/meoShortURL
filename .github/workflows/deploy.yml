name: Deploy to VPS

on:
  push:
    branches:
      - main

env:
  # ดึงค่าจาก Secrets มาพักไว้
  APP_DIR: ${{ secrets.APP_DIR }}
  SSH_HOST: ${{ secrets.SSH_HOST }}
  SSH_USER: ${{ secrets.SSH_USER }}
  SSH_PORT: ${{ secrets.SSH_PORT }}
  # ค่า Config ของแอป
  BASE_URL: ${{ secrets.BASE_URL }}
  PORT: ${{ secrets.PORT }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    # ลบบรรทัด if ทิ้งไปแล้ว เพื่อแก้ปัญหา Error

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH Key
        env:
          SSH_KEY: ${{ secrets.SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # เพิ่ม Host Key เพื่อไม่ให้ถาม yes/no ตอนเชื่อมต่อ
          ssh-keyscan -p "${SSH_PORT:-22}" "$SSH_HOST" >> ~/.ssh/known_hosts

      - name: Upload project files
        run: |
          # สร้างโฟลเดอร์ปลายทาง
          ssh -p "${SSH_PORT:-22}" "$SSH_USER@$SSH_HOST" "mkdir -p '$APP_DIR'"

          # บีบอัดไฟล์และส่งข้ามไป
          tar -czf - \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='.github' \
            --exclude='*.sqlite' \
            --exclude='.env' \
            . | ssh -p "${SSH_PORT:-22}" "$SSH_USER@$SSH_HOST" "tar -xzf - -C '$APP_DIR'"

      - name: Deploy with Docker Compose
        run: |
          ssh -p "${SSH_PORT:-22}" "$SSH_USER@$SSH_HOST" <<EOF
            set -e
            cd "$APP_DIR"
            
            # 1. สร้างไฟล์ .env บน Server
            echo "BASE_URL=${BASE_URL}" > .env
            echo "PORT=${PORT}" >> .env
            
            # 2. สั่ง Build และ Run
            docker compose up -d --build --remove-orphans
            
            # 3. ลบ Image ขยะ
            docker image prune -f
          EOF
