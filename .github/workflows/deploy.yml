name: Deploy to VPS

on:
  push:
    branches:
      - main

env:
  APP_DIR: ${{ secrets.APP_DIR }}
  SSH_HOST: ${{ secrets.SSH_HOST }}
  SSH_USER: ${{ secrets.SSH_USER }}
  SSH_PORT: ${{ secrets.SSH_PORT }}
  BASE_URL: ${{ secrets.BASE_URL }}
  PORT: ${{ secrets.PORT }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ env.SSH_HOST != '' && env.SSH_USER != '' && env.APP_DIR != '' && secrets.SSH_KEY != '' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH
        env:
          SSH_KEY: ${{ secrets.SSH_KEY }}
        run: |
          set -e
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p "${SSH_PORT:-22}" "$SSH_HOST" >> ~/.ssh/known_hosts

      - name: Upload project files
        run: |
          set -e
          ssh -p "${SSH_PORT:-22}" "$SSH_USER@$SSH_HOST" "mkdir -p '$APP_DIR'"
          tar -czf - \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='.github' \
            --exclude='urls.sqlite' \
            . | ssh -p "${SSH_PORT:-22}" "$SSH_USER@$SSH_HOST" "tar -xzf - -C '$APP_DIR'"

      - name: Deploy with Docker Compose
        run: |
          set -e
          ssh -p "${SSH_PORT:-22}" "$SSH_USER@$SSH_HOST" <<EOF
            set -e
            cd "$APP_DIR"
            export BASE_URL="${BASE_URL:-}"
            export PORT="${PORT:-3000}"
            docker compose down --remove-orphans || true
            docker compose build --pull
            docker compose up -d
          EOF
